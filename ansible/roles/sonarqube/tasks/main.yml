---
# tasks file for sonarqube
- name: Update apt
  apt:
    update_cache: yes
    upgrade: yes

- name: Add PostgreSQL repository
  lineinfile:
    path: /etc/apt/sources.list.d/pgdg.list
    line: 'deb http://apt.postgresql.org/pub/repos/apt {{ ansible_distribution_release }}-pgdg main'
    create: yes

- name: Download PostgreSQL GPG key
  get_url:
    url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
    dest: /etc/apt/trusted.gpg.d/pgdg.asc

- name: Update apt package cache
  apt:
    update_cache: yes

- name: Install PostgreSQL and PostgreSQL-contrib packages
  apt:
    name:
      - postgresql
      - postgresql-contrib
    state: present
    update_cache: yes

- name: Enable PostgreSQL service
  systemd:
    name: postgresql
    enabled: yes

- name: Change Postgres password for Sonarqube
  shell: |
    echo 'sonarqube' | sudo passwd --stdin postgres

############################

- name: Unzip ansible configuration file
  shell: |
    tar -xvf configurations-management.tar
  args:
    chdir: "/home/ubuntu"
  register: ansible_cfg_check

- name: Install Ansible
  become: yes
  become_user: root
  shell: |
    apt-add-repository ppa:ansible/ansible -y
    apt update -y
    apt install ansible -y
  args:
    chdir: "/home/ubuntu"
  register: ansible_install_check

- name: Run playbook config all
  shell: |
    ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook -i ./inventory/lite-hosts.yaml playbook.yaml -vvv
  args:
    chdir: "/home/ubuntu/configurations-management"
  when: ansible_cfg_check is success and ansible_install_check is success and not ansible_check_mode